# Cocktail Private Hub 서버 설치

내부 테스트 목적으로 Cocktail Private Hub를 설치하여 사용하는 방법은 아래와 같다.

* Docker 설치

Cocktail Private Hub를 설치하기 위한 VM또는 machine에서 먼저 Docker를 설치한다.

```
# sudo su - root
# yum install –y yum-utils
# yum-config-manager  --add-repo https://download.docker.com/linux/centos/docker-ce.repo
# yum makecache fast
# yum install -y docker-ce
# systemctl enable docker
# systemctl start docker
```

* Docker-Compose 설치

Docker-Compose 설치를 위한 방법은 아래와 같다.

    # curl -L https://github.com/docker/compose/releases/download/1.12.0/docker-compose-`uname -s`-`uname -m` > docker-compose
    # chmod +x docker-compose
    # mv docker-compose /usr/local/bin/
    # docker-compose --version

* Harbor 설치

Harbor 설치를 위한 방법은 아래와 같다.

```
# wget https://github.com/vmware/harbor/releases/download/v1.1.1-rc4/harbor-online-installer-v1.1.1-rc4.tgz
# tar -zxvf harbor-online-installer-v1.1.1-rc4.tgz
# vi harbor/harbor.cfg
...
hostname = 서버 ip
ui_url_protocol = https
db_password = root123
ssl_cert = harbor crt 파일 경로 (예, /root/cert/harbor.crt)
ssl_cert_key = harbor 인증서 key 파일 경로 (예, /root/cert/harbor.key)
harbor_admin_password = C0ckt@1lAdmin
...

# ./install.sh
```

* Docker Build Server 설치.

Docker build Server는 docker상에 container로 실행되며 Cocktail Builder-api component와 통신하게 된다.

또한,  Docker Server와 Docker Client간 로컬이 아닌 원격지에서는 반드시 TLS로 통신해야 함으로 사설인증서를 생성하여 설정해 준다.

이를 편하게 설정하기 위해 "create-docker-tls.sh" 파일을 설치하고자 하는 VM 또는 machine에 upload하여 실행한다.

```
# ./create-docker-tls.sh "도메인 또는 IP"
# cd /root/.docker
# ls -al
# vi /etc/profile.d/docker.sh
  export DOCKER_CERT_PATH=/root/home/.docker -> export DOCKER_CERT_PATH=/root/.docker 로 변경

# ./docker.sh
# vi /lib/systemd/system/docker.service  

ExecStart=/usr/bin/dockerd -H tcp://0.0.0.0:2376 -H unix:///var/run/docker.sock --tlsverify --tlscacert=/root/.docker/ca.pem --tlscert=/root/.docker/server-cert.pem --tlskey=/root/.docker/server-key.pem

# daemin-reload
# systemctl restart docker

7. ca.pem ,cert.pem ,key.pem 파일을 BASE64 인코딩 후 k8s 대시보드에서 Builder API 서버 CA_PEM, CERT_PEM, KEY_PEM에 각각 맞게 넣어주고
REGISTRY_URL, DOCKER_URL을 하버레지스트리 도메인 이름으로 변경
8. Cocktail-api 서버도 REGISTRY_URL부분을 하버레지스트리 도메인 이름으로 변경
```

* Cocktail에서 builder-api, client-api deployment update

k8s dashboard에서 builder-api의 환경변수 REGISTRY_URL, DOCKER\_URL, SERVER\_TYPE, CA\_PEM, CERT\_PEM, KEY\_PEM 를 수정하고, cocktail-api의 환경변수 REGISTRY\_URL을 수정한다._

| 환경변수 | 값 예시 |
| :--- | :--- |
| REGISTRY\_URL | 172.10.1.1 |
| DOCKER\_URL | https://172.10.1.1 |
| SERVER\_TYPE | 임의의 string |
| CA\_PEM |  |
| CERT\_PEM |  |
| KEY\_PEM |  |

| 환경변수 | 값 예시 |
| :--- | :--- |
| REGISTRY\_URL | https://172.10.1.1 |
| REGISTRY\_USER | harbor login id \(admin\) |
| REGISTRY\_PASSWORD | harbor login passwd \(C0ckt@1!Admin\) |

참고 사이트 - [https://github.com/vmware/harbor/blob/master/docs/configure\_https.md](https://github.com/vmware/harbor/blob/master/docs/configure_https.md)

먼저, Harbor가 설치된 서버에서 인증서를 생성하고 harbor.cfg에 관련 내용을 설정한다.

```
openssl req -newkey rsa:4096 -nodes -sha256 -keyout ca.key -x509 -days 3650 -out ca.crt
openssl req -newkey rsa:4096 -nodes -sha256 -keyout harbor.key -out harbor.csr
echo subjectAltName = IP:52.79.214.147 > extfile.cnf
openssl x509 -req -days 365 -in harbor.csr -CA ca.crt -CAkey ca.key -CAcreateserial -extfile extfile.cnf -out harbor.crt
mkdir -p /root/cert
cp harbor.crt /root/cert
cp harbor.key /root/cert
vi harbor.cfg
./prepare
docker-compose start
docker-compose down
docker-compose up -d
mkdir -p /etc/docker/certs.d/52.79.214.147
cp ca.crt /etc/docker/certs.d/52.79.214.147
docker login 52.79.214.147
```

참고 사이트 - [https://github.com/vmware/harbor/blob/master/docs/configure\_https.md](https://github.com/vmware/harbor/blob/master/docs/configure_https.md)

먼저, Harbor가 설치된 서버에서 인증서를 생성하고 harbor.cfg에 관련 내용을 설정한다.

```
openssl req -newkey rsa:4096 -nodes -sha256 -keyout ca.key -x509 -days 3650 -out ca.crt
openssl req -newkey rsa:4096 -nodes -sha256 -keyout harbor.key -out harbor.csr
echo subjectAltName = IP:52.79.214.147 > extfile.cnf
openssl x509 -req -days 365 -in harbor.csr -CA ca.crt -CAkey ca.key -CAcreateserial -extfile extfile.cnf -out harbor.crt
mkdir -p /root/cert
cp harbor.crt /root/cert
cp harbor.key /root/cert
vi harbor.cfg
./prepare
docker-compose start
docker-compose down
docker-compose up -d
mkdir -p /etc/docker/certs.d/52.79.214.147
cp ca.crt /etc/docker/certs.d/52.79.214.147
docker login 52.79.214.147
```

```
## Configuration file of Harbor

#The IP address or hostname to access admin UI and registry service.
#DO NOT use localhost or 127.0.0.1, because Harbor needs to be accessed by external clients.
hostname = 52.79.214.147

#The protocol for accessing the UI and token/notification service, by default it is http.
#It can be set to https if ssl is enabled on nginx.
ui_url_protocol = https

#The password for the root user of mysql db, change this before any production use.
db_password = root123

#Maximum number of job workers in job service
max_job_workers = 3

#Determine whether or not to generate certificate for the registry's token.
#If the value is on, the prepare script creates new root cert and private key
#for generating token to access the registry. If the value is off the default key/cert will be used.
#This flag also controls the creation of the notary signer's cert.
customize_crt = on

#The path of cert and key files for nginx, they are applied only the protocol is set to https
ssl_cert = /root/cert/harbor.crt
ssl_cert_key = /root/cert/harbor.key

#The path of secretkey storage
secretkey_path = /data
…
harbor_admin_password = C0ckt@1lAdmin
…
```

접속 클라이언트에서 Harbor 서버에서 생성한 ca.crt파일을 /etc/docker/certs.d/serverip/ 밑에 복사한다.

```
mkdir -p /etc/docker/certs.d/52.79.214.147
이후 ca.crt를 복사한다.
```

이후에는 k8s dashboard에서 builder-api와 cocktail-api component의 deployment를 수정한다.

