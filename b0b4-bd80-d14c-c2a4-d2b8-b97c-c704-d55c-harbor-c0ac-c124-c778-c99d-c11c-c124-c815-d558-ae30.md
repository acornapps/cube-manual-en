Cocktail Private Hub Server Installation

**1.Download and Install Required Software**

* Install Docker and Docker-compose and download/decompress Harbor installation file

For the Cocktail Private Hub installation, upload and run the following init.sh file on the target device to install Docker and Docker-compose and download/decompress the Harbor installation file.

Create working directory and upload installation script

```
// Changes as root user
# sudo su - root

// Stop firewall
# systemctl stop firewalld
# systemctl disable firewalld

// Changes selinux to disabled
# vi /etc/sysconfig/selinux
SELINUX=disabled

// Creates working directory
# mkdir -p /root/cocktail/cert/harbor
# mkdir -p /root/cocktail/cert/docker
```

```
//Downloads/Installs docker, docker-compose, and harbor 
# vi /root/init.sh 
    yum install -y yum-utils
    yum-config-manager --add-repo https://download.docker.com/linux/centos/docker-ce.repo
    yum makecache fast
    yum install -y --setopt=obsoletes=0 \
      docker-ce-17.03.1.ce-1.el7.centos \
      docker-ce-selinux-17.03.1.ce-1.el7.centos
    systemctl enable docker
    systemctl start docker

    curl -L https://github.com/docker/compose/releases/download/1.12.0/docker-compose-`uname -s`-`uname -m` > docker-compose
    chmod +x docker-compose
    mv docker-compose /usr/local/bin/
    docker-compose --version

    yum install -y wget
    wget https://github.com/vmware/harbor/releases/download/v1.1.1-rc4/harbor-online-installer-v1.1.1-rc4.tgz
    tar -zxvf harbor-online-installer-v1.1.1-rc4.tgz

    # chmod 755 /root/init.sh

```
// Creates openssl.cnf
# vi /root/cert/openssl.cnf
[ req ]
distinguished_name = req_distinguished_name
[req_distinguished_name]
[ v3_ca ]
basicConstraints = critical, CA:TRUE
keyUsage = critical, digitalSignature, keyEncipherment, keyCertSign

[ v3_req_server ]
basicConstraints = CA:FALSE
keyUsage = critical, digitalSignature, keyEncipherment
extendedKeyUsage = serverAuth
subjectAltName = @alt_names_harbor

[ v3_builder_server ]
basicConstraints = CA:FALSE
keyUsage = critical, digitalSignature, keyEncipherment
extendedKeyUsage = serverAuth
subjectAltName = @alt_names_builder

[ v3_builder_client ]
basicConstraints = CA:FALSE
keyUsage = critical, digitalSignature, keyEncipherment
extendedKeyUsage = clientAuth

[ alt_names_harbor ]
DNS.1 = localhost
IP.1 = 172.30.1.56 // registry server IP
IP.2 = 127.0.0.1

[ alt_names_builder ]
DNS.1 = localhost
IP.1 = 172.30.1.56 // registry server IP
IP.2 = 127.0.0.1

# chmod 755 /root/cert/openssl.cnf
```

```
// Creates harbor certificate
# chmod 755 /root/cocktail/cert/harbor/make_harbor_cert.sh
# /root/cocktail/cert/harbor/make_harbor_cert.sh
```

```
// Creates docker certificate
# chmod 755 /root/cocktail/cert/docker/make_docker_cert.sh
# /root/cert/cocktail/docker/make_docker_cert.sh {registry_ip}
```

**2.Harbor Settings**

* **Harbor.cfg 파일 수정하기**

```
# vi ~/cocktail/harbor/harbor.cfg
...
hostname = {harbor_ip}
ui_url_protocol = https
ssl_cert = /root/cocktail/cert/harbor/harbor.crt     // harbor crt file path
ssl_cert_key = /root/cocktail/cert/harbor/harbor.key // harbor certificate key file path
harbor_admin_password = C0ckt@1lAdmin
...
```

* **Harbor startup**

Run the install.sh script to generate Harbor settings files and start harbor

```
# cd /root/cocktail/harbor
# ./install.sh

// Verifies whether Harbor started up normally. (Normal if 7 containers in total are running)
# docker ps
```

* **Verifying whether Harbor login via Docker client on target equipment is functioning properly.**

Copy the ca.crt file created on the Harbor server to /etc/docker/certs.d/{harbor_ip}/ where the Docker client verifies the certificate.

`Important!` Folder creation must follow the format shown below.

```
# mkdir -p /etc/docker/certs.d/{harbor_ip}
# cp /root/cocktail/cert/harbor/ca.crt /etc/docker/certs.d/{harbor_ip}
# docker login https://{harbor_ip}
```

&lt; Note - When Running, Stopping, or Reconfiguring Harbor &gt;

Harbor runs automatically at boot time. To manually start, stop, or reconfigure Harbor, execute the following command:

```
# cd ~/cocktail/harbor
# docker-compose start
# docker-compose stop

If settings have been changed, run the install.sh file again.
```

---

**3.Cocktail Build Server Installation**

The Cocktail build server runs as a container on Docker and communicates with the Cocktail builder-api component.

Generally, remote communication between a Docker server and Docker client must be performed via TLS, and so a private certificate must be generated and set up.

To make this process easier, the "make_docker_cert.sh" file is uploaded to (or created on) and run on the target virtual or physical machine.

```
# cd /root/cocktail/cert/doker
# ./make_docker_cert.sh {harbor_ip or domain}

# cd /root/.docker
# ls -al                   // Verifies whether the certificate was actually generated.
drwx------. 2 root root  211 12월 19 15:18 .
dr-xr-x---. 6 root root  204 12월 19 15:15 ..
-rw-r--r--. 1 root root 1980 12월 19 15:18 ca.crt
-rw-r--r--. 1 root root    3 12월 19 15:18 ca.srl
-rw-r--r--. 1 root root 1464 12월 19 15:18 cert.pem
-rw-r--r--. 1 root root  895 12월 19 15:18 client.csr
-rw-------. 1 root root  159 12월 19 15:15 config.json
-rw-r--r--. 1 root root   30 12월 19 15:18 extfile.cnf
-rw-r--r--. 1 root root 1679 12월 19 15:18 key.pem
-rw-r--r--. 1 root root 1428 12월 19 15:18 server-cert.pem
-rw-r--r--. 1 root root 1679 12월 19 15:18 server-key.pem
-rw-r--r--. 1 root root  899 12월 19 15:18 server.csr

// 시스템 전역 환경설정 파일 수정 및 실행.
# cd /etc/profile.d
# vi docker.sh
  export DOCKER_CERT_PATH 의 값을 /root/.docker 로 변경
# ./docker.sh

// docker service 파일 수정.
# vi /lib/systemd/system/docker.service

#ExecStart=/usr/bin/dockerd  // 주석으로 처리    
ExecStart=/usr/bin/dockerd -H tcp://0.0.0.0:2376 -H unix:///var/run/docker.sock --tlsverify --tlscacert=/root/.docker/ca.crt --tlscert=/root/.docker/server.crt --tlskey=/root/.docker/server.key

// Docker service restart
# systemctl daemon-reload
# systemctl restart docker
*
// Docker daemon이 정상적으로 실행됬는지 확인
# docker ps
```

** 4. Copy Harbor's CA file to all nodes to pull the image stored on Harbor from all nodes that constitute a k8s cluster.**

k8s cluster를 구성하는 모든 node에서 harbor로 부터 image를 pull하기 위해 harbor 설치시에 생성한 ca.crt파일을 모든  node의 /etc/docker/certs.d/serverip/ 밑에 복사한다.

```
mkdir -p /etc/docker/certs.d/xxx.xxx.xxx.xxx  (중요. xxx.xxx.xxx.xxx는 harbor를 설치한 ip임)
이후 ca.crt를 복사한다.
```

5**. Cocktail builder-api, client-api의 환경 변수 수정.**

k8s dashboard에서 builder-api의 환경변수 REGISTRY_URL, DOCKER\_URL, SERVER\_TYPE, CA\_PEM, CERT\_PEM, KEY\_PEM 를 수정하고, cocktail-api의 환경변수 REGISTRY\_URL을 수정한다._

* builder-api

| 환경변수 | 값 예시 |
| :--- | :--- |
| REGISTRY\_URL | xxx.xxx.xxx.xxx |
| DOCKER\_URL | [https://xxx.xxx.xxx.xx](https://172.10.1.1)x |
| SERVER\_TYPE | 임의의 string |
| CA\_PEM | CA 인증키인 ca.crt파일을 base64 encoding해서  입력 |
|  | \# cat /root/.docker/ca.crt 의 결과값을 [https://www.base64encode.org에서](https://www.base64encode.org에서) encoding하여 입력 |
| CERT\_PEM | build server cert.pem파일을 base64 encoding해서 입력 |
|  | \# cat /root/.docker/cert.pem의 결과값을 [https://www.base64encode.org에서](https://www.base64encode.org에서) encoding하여 입력 |
| KEY\_PEM | build server key.pem파일을 base64 encoding해서 입력 |
|  | \# cat /root/.docker/key.pem의 결과값을 [https://www.base64encode.org에서](https://www.base64encode.org에서) encoding하여 입력 |

* cocktail-api

| 환경변수 | 값 예시 |
| :--- | :--- |
| REGISTRY\_URL | [https://](https://172.10.1.1)xxx.xxx.xxx.xxx |
| REGISTRY\_USER | harbor login id |
| REGISTRY\_PASSWORD | habor login passwd |



